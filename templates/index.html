{% extends "base.html" %}

{% block content %}
<div class="bg-white rounded-lg shadow-lg p-6">
    <div class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-4">
            <h1 class="text-3xl font-bold text-gray-800">My Policies</h1>
            <!-- Search Box -->
            <form action="{{ url_for('search') }}" method="get" class="relative">
                <input type="text" name="q" placeholder="Search policies..."
                       class="px-4 py-2 pr-10 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-64"
                       value="{{ request.args.get('q', '') }}">
                <button type="submit" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-search"></i>
                </button>
            </form>
        </div>
        <div class="flex gap-3">
            <!-- Multi-select Category Filter -->
            <div class="relative">
                <button onclick="toggleCategoryFilter()"
                        class="px-4 py-2 border border-gray-300 rounded-lg bg-white hover:bg-gray-50 flex items-center gap-2">
                    <i class="fas fa-filter text-gray-600"></i>
                    <span id="filterButtonText">
                        {% if selected_categories %}
                            {{ selected_categories|length }} Selected
                        {% else %}
                            All Categories
                        {% endif %}
                    </span>
                    <i class="fas fa-chevron-down text-gray-400 text-sm"></i>
                </button>
                <div id="categoryFilterDropdown" class="hidden absolute right-0 mt-2 w-64 bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-h-96 overflow-y-auto">
                    <div class="p-3">
                        <div class="flex justify-between items-center mb-2 pb-2 border-b">
                            <span class="font-semibold text-gray-700">Filter by Category</span>
                            <button onclick="clearFilters()" class="text-sm text-blue-600 hover:text-blue-800">Clear</button>
                        </div>
                        <form id="categoryFilterForm" method="get" action="{{ url_for('policies') }}">
                            {% for category in categories %}
                            <label class="flex items-center py-2 hover:bg-gray-50 cursor-pointer rounded px-2">
                                <input type="checkbox" name="category" value="{{ category.name }}"
                                       {% if category.name in selected_categories %}checked{% endif %}
                                       onchange="updateFilter()"
                                       class="rounded text-blue-600 focus:ring-blue-500 mr-3">
                                <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: {{ category.color }}"></span>
                                <span class="text-sm text-gray-700">{{ category.name }}</span>
                            </label>
                            {% endfor %}
                        </form>
                    </div>
                </div>
            </div>
            <button onclick="document.getElementById('addModal').classList.remove('hidden')"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                <i class="fas fa-plus mr-2"></i>Add Policy
            </button>
        </div>
    </div>

    {% macro sort_link(column_key, column_label, current_sort, current_order) %}
        {% set new_order = 'desc' if (column_key == current_sort and current_order == 'asc') else 'asc' %}
        {% set url_args = request.args.to_dict(flat=False) %}
        {% set _ = url_args.update({'sort': [column_key], 'order': [new_order]}) %}
        <a href="{{ url_for(request.endpoint, **url_args|urlencode_dict) }}"
           class="flex items-center justify-between w-full group hover:text-blue-600 transition duration-150">
            <span>{{ column_label }}</span>
            {% if current_sort == column_key %}
                <i class="fas fa-sort-{{ 'up' if current_order == 'asc' else 'down' }} ml-2 text-blue-600"></i>
            {% else %}
                <i class="fas fa-sort ml-2 text-gray-300 group-hover:text-gray-400"></i>
            {% endif %}
        </a>
    {% endmacro %}

    {% if policies %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {{ sort_link('name', 'Name', current_sort, current_order) }}
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {{ sort_link('provider', 'Provider', current_sort, current_order) }}
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {{ sort_link('category', 'Category', current_sort, current_order) }}
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {{ sort_link('end_date', 'End Date', current_sort, current_order) }}
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Days Left</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {{ sort_link('monthly', 'Monthly', current_sort, current_order) }}
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {{ sort_link('annual', 'Annual', current_sort, current_order) }}
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {{ sort_link('balance', 'Balance', current_sort, current_order) }}
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for policy in policies %}
                <tr class="{% if policy.days_until_expiry < 30 %}bg-red-50{% elif policy.days_until_expiry < 60 %}bg-yellow-50{% endif %}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">{{ policy.friendly_name }}</div>
                        <div class="text-xs text-gray-500">{{ policy.policy_number }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ policy.insurer }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold text-white" style="background-color: {{ policy.category_color }}">{{ policy.category }}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ policy.end_date }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {% if policy.days_until_expiry < 0 %}
                        <span class="text-red-600 font-semibold">Expired</span>
                        {% elif policy.days_until_expiry < 30 %}
                        <span class="text-red-600 font-semibold">{{ policy.days_until_expiry }} days</span>
                        {% elif policy.days_until_expiry < 60 %}
                        <span class="text-yellow-600 font-semibold">{{ policy.days_until_expiry }} days</span>
                        {% else %}
                        <span class="text-green-600">{{ policy.days_until_expiry }} days</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {{ policy.monthly_amount | format_currency }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {{ policy.annual_amount | format_currency }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {% if policy.category == 'Mortgage' and policy.remaining_balance %}
                        {{ policy.remaining_balance | format_currency }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex items-center space-x-3">
                            {% if policy.insurer_website %}
                            <a href="{{ policy.insurer_website }}" target="_blank" class="text-blue-600 hover:text-blue-900" title="Visit website">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            {% endif %}
                            <a href="{{ url_for('edit_policy', id=policy.id) }}" class="text-indigo-600 hover:text-indigo-900" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{{ url_for('delete_policy', id=policy.id) }}"
                               onclick="return confirm('Are you sure you want to delete this policy?')"
                               class="text-red-600 hover:text-red-900" title="Delete">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot class="bg-gray-100 border-t-2 border-gray-300">
                <tr>
                    <td colspan="5" class="px-6 py-4 text-right font-bold text-gray-700">Totals:</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">
                        {{ (policies | selectattr('monthly_amount') | sum(attribute='monthly_amount') | default(0)) | format_currency }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">
                        {{ (policies | selectattr('annual_amount') | sum(attribute='annual_amount') | default(0)) | format_currency }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">
                        {{ (policies | selectattr('remaining_balance') | sum(attribute='remaining_balance') | default(0)) | format_currency }}
                    </td>
                    <td class="px-6 py-4"></td>
                </tr>
            </tfoot>
        </table>
    </div>
    {% else %}
    <div class="text-center py-12">
        <i class="fas fa-file-invoice text-gray-300 text-6xl mb-4"></i>
        <p class="text-gray-500 text-lg">No policies found. Add your first policy to get started!</p>
    </div>
    {% endif %}
</div>

<!-- Add Policy Modal -->
<div id="addModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-3/4 shadow-lg rounded-lg bg-white max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-gray-900">Add New Policy</h3>
            <button onclick="document.getElementById('addModal').classList.add('hidden')" 
                    class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <form method="POST" action="{{ url_for('add_policy') }}">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Friendly Name *</label>
                    <input type="text" name="friendly_name" required placeholder="e.g., Home Mortgage"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Policy/Account Number *</label>
                    <input type="text" name="policy_number" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Provider/Insurer *</label>
                    <input type="text" name="insurer" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Category *</label>
                    <select name="category" id="category_add" required onchange="toggleRemainingBalance('add')" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Category</option>
                        {% for category in categories %}
                        <option value="{{ category.name }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Start Date *</label>
                    <input type="date" name="start_date" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">End Date *</label>
                    <input type="date" name="end_date" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Monthly Amount</label>
                    <input type="number" step="0.01" name="monthly_amount" id="monthly_amount"
                           onchange="calculateAnnual()"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Annual Amount</label>
                    <input type="number" step="0.01" name="annual_amount" id="annual_amount"
                           onchange="calculateMonthly()"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="remaining_balance_add" style="display: none;">
                    <label class="block text-gray-700 font-semibold mb-2">Remaining Balance</label>
                    <input type="number" step="0.01" name="remaining_balance"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Account Source</label>
                    <input type="text" name="account_source"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Provider Website</label>
                    <input type="url" name="insurer_website" placeholder="https://example.com"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-gray-700 font-semibold mb-2">Notes</label>
                    <textarea name="notes" rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" 
                        onclick="document.getElementById('addModal').classList.add('hidden')"
                        class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition duration-200">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                    Add Policy
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function calculateAnnual() {
    const monthly = document.getElementById('monthly_amount').value;
    if (monthly) {
        document.getElementById('annual_amount').value = (parseFloat(monthly) * 12).toFixed(2);
    }
}

function calculateMonthly() {
    const annual = document.getElementById('annual_amount').value;
    if (annual) {
        document.getElementById('monthly_amount').value = (parseFloat(annual) / 12).toFixed(2);
    }
}

function toggleRemainingBalance(context) {
    const categorySelect = document.getElementById('category_' + context);
    const remainingBalanceDiv = document.getElementById('remaining_balance_' + context);

    if (categorySelect && remainingBalanceDiv) {
        if (categorySelect.value === 'Mortgage') {
            remainingBalanceDiv.style.display = 'block';
        } else {
            remainingBalanceDiv.style.display = 'none';
        }
    }
}

// Category filter functions
function toggleCategoryFilter() {
    const dropdown = document.getElementById('categoryFilterDropdown');
    dropdown.classList.toggle('hidden');
}

function updateFilter() {
    document.getElementById('categoryFilterForm').submit();
}

function clearFilters() {
    const checkboxes = document.querySelectorAll('#categoryFilterForm input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    document.getElementById('categoryFilterForm').submit();
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('categoryFilterDropdown');
    const button = event.target.closest('button');

    if (!dropdown.contains(event.target) && button?.onclick?.toString().indexOf('toggleCategoryFilter') === -1) {
        dropdown.classList.add('hidden');
    }
});
</script>
{% endblock %}
