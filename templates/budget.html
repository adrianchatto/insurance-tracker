{% extends "base.html" %}

{% block content %}
<div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Budget Tracker</h1>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <div class="text-sm text-green-600 font-semibold">Total Income</div>
            <div class="text-2xl font-bold text-green-700">{{ total_income | format_currency }}</div>
        </div>
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="text-sm text-red-600 font-semibold">Total Expenses</div>
            <div class="text-2xl font-bold text-red-700">{{ total_expenses | format_currency }}</div>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="text-sm text-blue-600 font-semibold">Fixed Costs</div>
            <div class="text-2xl font-bold text-blue-700">{{ fixed_costs | format_currency }}</div>
        </div>
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
            <div class="text-sm text-purple-600 font-semibold">Discretionary</div>
            <div class="text-2xl font-bold text-purple-700">{{ discretionary | format_currency }}</div>
        </div>
    </div>

    <!-- Net Income/Savings -->
    <div class="mb-6 p-4 rounded-lg {% if net_income >= 0 %}bg-green-100 border border-green-300{% else %}bg-red-100 border border-red-300{% endif %}">
        <div class="flex justify-between items-center">
            <span class="text-lg font-semibold {% if net_income >= 0 %}text-green-800{% else %}text-red-800{% endif %}">
                Net Income (Savings):
            </span>
            <span class="text-2xl font-bold {% if net_income >= 0 %}text-green-900{% else %}text-red-900{% endif %}">
                {{ net_income | format_currency }}
            </span>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white border border-gray-200 rounded-lg p-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Expenses by Category</h3>
            <canvas id="categoryChart"></canvas>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg p-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Fixed vs Discretionary</h3>
            <canvas id="fixedDiscChart"></canvas>
        </div>
    </div>
</div>

<!-- Income Section -->
<div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Income Sources</h2>
        <button onclick="document.getElementById('addIncomeModal').classList.remove('hidden')"
                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
            <i class="fas fa-plus mr-2"></i>Add Income
        </button>
    </div>

    {% if income_items %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frequency</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for item in income_items %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ item.name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">{{ item.amount | format_currency }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.frequency | capitalize }}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">{{ item.notes or '-' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <a href="{{ url_for('delete_budget_item', id=item.id) }}"
                           onclick="return confirm('Are you sure you want to delete this income source?')"
                           class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-8 text-gray-500">No income sources added yet.</div>
    {% endif %}
</div>

<!-- Expenses Section -->
<div class="bg-white rounded-lg shadow-lg p-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Expenses</h2>
        <button onclick="document.getElementById('addExpenseModal').classList.remove('hidden')"
                class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200">
            <i class="fas fa-plus mr-2"></i>Add Expense
        </button>
    </div>

    {% if expense_items %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frequency</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for item in expense_items %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ item.name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.category or 'Other' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-semibold">{{ item.amount | format_currency }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold {% if item.is_fixed_cost %}bg-blue-100 text-blue-800{% else %}bg-purple-100 text-purple-800{% endif %}">
                            {{ 'Fixed' if item.is_fixed_cost else 'Discretionary' }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.frequency | capitalize }}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">{{ item.notes or '-' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <a href="{{ url_for('delete_budget_item', id=item.id) }}"
                           onclick="return confirm('Are you sure you want to delete this expense?')"
                           class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-8 text-gray-500">No expenses added yet.</div>
    {% endif %}
</div>

<!-- Add Income Modal -->
<div id="addIncomeModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-gray-900">Add Income Source</h3>
            <button onclick="document.getElementById('addIncomeModal').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <form method="POST" action="{{ url_for('add_budget_item') }}">
            <input type="hidden" name="type" value="income">
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Name *</label>
                    <input type="text" name="name" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Amount (Monthly) *</label>
                    <input type="number" step="0.01" name="amount" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Frequency</label>
                    <select name="frequency"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="monthly" selected>Monthly</option>
                        <option value="annual">Annual</option>
                        <option value="one-time">One-time</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Notes</label>
                    <textarea name="notes" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button"
                        onclick="document.getElementById('addIncomeModal').classList.add('hidden')"
                        class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition duration-200">
                    Cancel
                </button>
                <button type="submit"
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">
                    Add Income
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Expense Modal -->
<div id="addExpenseModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-gray-900">Add Expense</h3>
            <button onclick="document.getElementById('addExpenseModal').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <form method="POST" action="{{ url_for('add_budget_item') }}">
            <input type="hidden" name="type" value="expense">
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Name *</label>
                    <input type="text" name="name" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Category</label>
                    <select name="category"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        <option value="">Select Category</option>
                        {% for category in categories %}
                        <option value="{{ category.name }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Amount (Monthly) *</label>
                    <input type="number" step="0.01" name="amount" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Frequency</label>
                    <select name="frequency"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        <option value="monthly" selected>Monthly</option>
                        <option value="annual">Annual</option>
                        <option value="one-time">One-time</option>
                    </select>
                </div>
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" name="is_fixed_cost" class="mr-2 h-5 w-5">
                        <span class="text-gray-700 font-semibold">Fixed Cost (e.g., rent, mortgage, insurance)</span>
                    </label>
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Notes</label>
                    <textarea name="notes" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button"
                        onclick="document.getElementById('addExpenseModal').classList.add('hidden')"
                        class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition duration-200">
                    Cancel
                </button>
                <button type="submit"
                        class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200">
                    Add Expense
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Expenses by Category Pie Chart
const expensesByCategory = {{ expenses_by_category | tojson }};
const categoryLabels = Object.keys(expensesByCategory);
const categoryData = Object.values(expensesByCategory);

if (categoryLabels.length > 0) {
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
        type: 'pie',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryData,
                backgroundColor: [
                    '#10B981', '#3B82F6', '#F59E0B', '#8B5CF6', '#EC4899', '#6B7280',
                    '#EF4444', '#14B8A6', '#F97316', '#06B6D4'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return label + ': ' + new Intl.NumberFormat('en-GB', {
                                style: 'currency',
                                currency: 'GBP'
                            }).format(value) + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}

// Fixed vs Discretionary Pie Chart
const fixedAmount = {{ fixed_costs }};
const discretionaryAmount = {{ discretionary }};

if (fixedAmount > 0 || discretionaryAmount > 0) {
    const fixedDiscCtx = document.getElementById('fixedDiscChart').getContext('2d');
    new Chart(fixedDiscCtx, {
        type: 'doughnut',
        data: {
            labels: ['Fixed Costs', 'Discretionary'],
            datasets: [{
                data: [fixedAmount, discretionaryAmount],
                backgroundColor: ['#3B82F6', '#8B5CF6'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return label + ': ' + new Intl.NumberFormat('en-GB', {
                                style: 'currency',
                                currency: 'GBP'
                            }).format(value) + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}
