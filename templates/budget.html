{% extends "base.html" %}

{% block content %}
<div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <div class="flex items-center gap-4 mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Budget Tracker</h1>
        <!-- Search Box -->
        <form action="{{ url_for('search') }}" method="get" class="relative">
            <input type="text" name="q" placeholder="Search budget..."
                   class="px-4 py-2 pr-10 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-64"
                   value="{{ request.args.get('q', '') }}">
            <button type="submit" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                <i class="fas fa-search"></i>
            </button>
        </form>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <div class="text-sm text-green-600 font-semibold">Total Income</div>
            <div class="text-2xl font-bold text-green-700">{{ total_income | format_currency }}</div>
        </div>
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="text-sm text-red-600 font-semibold">Total Expenses</div>
            <div class="text-2xl font-bold text-red-700">{{ total_expenses | format_currency }}</div>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="text-sm text-blue-600 font-semibold">Fixed Costs</div>
            <div class="text-2xl font-bold text-blue-700">{{ fixed_costs | format_currency }}</div>
        </div>
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
            <div class="text-sm text-purple-600 font-semibold">Discretionary</div>
            <div class="text-2xl font-bold text-purple-700">{{ discretionary | format_currency }}</div>
        </div>
    </div>

    <!-- Net Income/Savings -->
    <div class="mb-6 p-4 rounded-lg {% if net_income >= 0 %}bg-green-100 border border-green-300{% else %}bg-red-100 border border-red-300{% endif %}">
        <div class="flex justify-between items-center">
            <span class="text-lg font-semibold {% if net_income >= 0 %}text-green-800{% else %}text-red-800{% endif %}">
                Net Income (Savings):
            </span>
            <span class="text-2xl font-bold {% if net_income >= 0 %}text-green-900{% else %}text-red-900{% endif %}">
                {{ net_income | format_currency }}
            </span>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white border border-gray-200 rounded-lg p-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Expenses by Category</h3>
            <div class="max-w-sm mx-auto">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg p-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Fixed vs Discretionary</h3>
            <div class="max-w-sm mx-auto">
                <canvas id="fixedDiscChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Income Section -->
<div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Income Sources</h2>
        <button onclick="document.getElementById('addIncomeModal').classList.remove('hidden')"
                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
            <i class="fas fa-plus mr-2"></i>Add Income
        </button>
    </div>

    {% if income_items %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frequency</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for item in income_items %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ item.name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">{{ item.amount | format_currency }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.frequency | capitalize }}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">{{ item.notes or '-' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editItem({{ item.id }})" class="text-indigo-600 hover:text-indigo-900 mr-3" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <a href="{{ url_for('delete_budget_item', id=item.id) }}"
                           onclick="return confirm('Are you sure you want to delete this income source?')"
                           class="text-red-600 hover:text-red-900" title="Delete">
                            <i class="fas fa-trash"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-8 text-gray-500">No income sources added yet.</div>
    {% endif %}
</div>

<!-- Expenses Section -->
<div id="expenses" class="bg-white rounded-lg shadow-lg p-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Expenses</h2>
        <div class="flex gap-3 items-center">
            <div class="flex items-center gap-2">
                <label for="perPageExpenses" class="text-sm text-gray-600">Show:</label>
                <select id="perPageExpenses" onchange="changePerPage(this.value)"
                        class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                </select>
                <span class="text-sm text-gray-600">per page</span>
            </div>
            <button onclick="document.getElementById('addExpenseModal').classList.remove('hidden')"
                    class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200">
                <i class="fas fa-plus mr-2"></i>Add Expense
            </button>
        </div>
    </div>

    {% if expense_items %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Policy</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frequency</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for item in expense_items %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {% if item.is_policy %}
                        <i class="fas fa-shield-alt text-blue-500 mr-2" title="Policy"></i>
                        {% endif %}
                        {{ item.name }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.category or 'Other' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-semibold">{{ item.amount | format_currency }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold {% if item.is_fixed_cost %}bg-blue-100 text-blue-800{% else %}bg-purple-100 text-purple-800{% endif %}">
                            {{ 'Fixed' if item.is_fixed_cost else 'Discretionary' }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" {% if item.is_policy %}checked{% endif %}
                                   onchange="togglePolicy({{ item.id }}, this)">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.frequency | capitalize }}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">{{ item.notes or '-' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editItem({{ item.id }})" class="text-indigo-600 hover:text-indigo-900 mr-3" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <a href="{{ url_for('delete_budget_item', id=item.id) }}"
                           onclick="return confirm('Are you sure you want to delete this expense?')"
                           class="text-red-600 hover:text-red-900" title="Delete">
                            <i class="fas fa-trash"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Expenses Pagination -->
    {% if expenses_total_pages > 1 %}
    <div class="mt-4 flex justify-between items-center">
        <div class="text-sm text-gray-600">
            Showing {{ (expenses_page - 1) * per_page + 1 }} to {{ [expenses_page * per_page, expenses_total] | min }} of {{ expenses_total }} expenses
        </div>
        <div class="flex gap-1">
            {% if expenses_page > 1 %}
            <a href="?expenses_page={{ expenses_page - 1 }}&per_page={{ per_page }}#expenses"
               class="px-3 py-1 border border-gray-300 rounded-lg text-sm hover:bg-gray-100 transition duration-200">
                Previous
            </a>
            {% endif %}

            {% for page in range(1, expenses_total_pages + 1) %}
                {% if page == expenses_page %}
                <span class="px-3 py-1 bg-blue-600 text-white rounded-lg text-sm">{{ page }}</span>
                {% elif page == 1 or page == expenses_total_pages or (page >= expenses_page - 2 and page <= expenses_page + 2) %}
                <a href="?expenses_page={{ page }}&per_page={{ per_page }}#expenses"
                   class="px-3 py-1 border border-gray-300 rounded-lg text-sm hover:bg-gray-100 transition duration-200">
                    {{ page }}
                </a>
                {% elif page == expenses_page - 3 or page == expenses_page + 3 %}
                <span class="px-3 py-1 text-gray-500">...</span>
                {% endif %}
            {% endfor %}

            {% if expenses_page < expenses_total_pages %}
            <a href="?expenses_page={{ expenses_page + 1 }}&per_page={{ per_page }}#expenses"
               class="px-3 py-1 border border-gray-300 rounded-lg text-sm hover:bg-gray-100 transition duration-200">
                Next
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <div class="text-center py-8 text-gray-500">No expenses added yet.</div>
    {% endif %}
</div>

<!-- Add Income Modal -->
<div id="addIncomeModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-gray-900">Add Income Source</h3>
            <button onclick="document.getElementById('addIncomeModal').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <form method="POST" action="{{ url_for('add_budget_item') }}">
            <input type="hidden" name="type" value="income">
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Name *</label>
                    <input type="text" name="name" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Amount (Monthly) *</label>
                    <input type="number" step="0.01" name="amount" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Frequency</label>
                    <select name="frequency"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="monthly" selected>Monthly</option>
                        <option value="annual">Annual</option>
                        <option value="one-time">One-time</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Notes</label>
                    <textarea name="notes" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button"
                        onclick="document.getElementById('addIncomeModal').classList.add('hidden')"
                        class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition duration-200">
                    Cancel
                </button>
                <button type="submit"
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">
                    Add Income
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Expense Modal -->
<div id="addExpenseModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-gray-900">Add Expense</h3>
            <button onclick="document.getElementById('addExpenseModal').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <form method="POST" action="{{ url_for('add_budget_item') }}">
            <input type="hidden" name="type" value="expense">
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Name *</label>
                    <input type="text" name="name" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Category</label>
                    <select name="category"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        <option value="">Select Category</option>
                        {% for category in categories %}
                        <option value="{{ category.name }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Amount (Monthly) *</label>
                    <input type="number" step="0.01" name="amount" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Frequency</label>
                    <select name="frequency"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        <option value="monthly" selected>Monthly</option>
                        <option value="annual">Annual</option>
                        <option value="one-time">One-time</option>
                    </select>
                </div>
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" name="is_fixed_cost" class="mr-2 h-5 w-5">
                        <span class="text-gray-700 font-semibold">Fixed Cost (e.g., rent, mortgage, insurance)</span>
                    </label>
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Notes</label>
                    <textarea name="notes" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button"
                        onclick="document.getElementById('addExpenseModal').classList.add('hidden')"
                        class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition duration-200">
                    Cancel
                </button>
                <button type="submit"
                        class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200">
                    Add Expense
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Budget Item Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-gray-900" id="editModalTitle">Edit Item</h3>
            <button onclick="closeEditModal()"
                    class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <form method="POST" id="editForm">
            <input type="hidden" name="type" id="edit_type">
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Name *</label>
                    <input type="text" name="name" id="edit_name" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="edit_category_div">
                    <label class="block text-gray-700 font-semibold mb-2">Category</label>
                    <select name="category" id="edit_category"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Category</option>
                        {% for category in categories %}
                        <option value="{{ category.name }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Amount (Monthly) *</label>
                    <input type="number" step="0.01" name="amount" id="edit_amount" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Frequency</label>
                    <select name="frequency" id="edit_frequency"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="monthly">Monthly</option>
                        <option value="annual">Annual</option>
                        <option value="one-time">One-time</option>
                    </select>
                </div>
                <div id="edit_fixed_cost_div">
                    <label class="flex items-center">
                        <input type="checkbox" name="is_fixed_cost" id="edit_is_fixed_cost" class="mr-2 h-5 w-5">
                        <span class="text-gray-700 font-semibold">Fixed Cost (e.g., rent, mortgage, insurance)</span>
                    </label>
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Notes</label>
                    <textarea name="notes" id="edit_notes" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button"
                        onclick="closeEditModal()"
                        class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition duration-200">
                    Cancel
                </button>
                <button type="submit"
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                    Update Item
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Change per page function
function changePerPage(perPage) {
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('per_page', perPage);
    urlParams.set('expenses_page', '1');
    urlParams.set('policies_page', '1');
    window.location.search = urlParams.toString();
}

// Edit item function
function editItem(id) {
    // Fetch item data
    fetch(`/budget/edit/${id}`)
        .then(response => response.json())
        .then(data => {
            // Populate form
            document.getElementById('edit_type').value = data.type;
            document.getElementById('edit_name').value = data.name;
            document.getElementById('edit_amount').value = data.amount;
            document.getElementById('edit_frequency').value = data.frequency;
            document.getElementById('edit_notes').value = data.notes || '';

            // Update form action
            document.getElementById('editForm').action = `/budget/edit/${id}`;

            // Update modal title
            document.getElementById('editModalTitle').textContent = data.type === 'income' ? 'Edit Income Source' : 'Edit Expense';

            // Show/hide category and fixed cost fields based on type
            if (data.type === 'expense') {
                document.getElementById('edit_category_div').style.display = 'block';
                document.getElementById('edit_fixed_cost_div').style.display = 'block';
                document.getElementById('edit_category').value = data.category || '';
                document.getElementById('edit_is_fixed_cost').checked = data.is_fixed_cost === 1;
            } else {
                document.getElementById('edit_category_div').style.display = 'none';
                document.getElementById('edit_fixed_cost_div').style.display = 'none';
            }

            // Show modal
            document.getElementById('editModal').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error fetching item:', error);
            alert('Error loading item data');
        });
}

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
}

// Toggle policy flag
function togglePolicy(id, checkbox) {
    fetch(`/budget/toggle_policy/${id}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Find the row and update the shield icon
            const row = checkbox.closest('tr');
            const nameCell = row.querySelector('td:first-child');
            const icon = nameCell.querySelector('.fa-shield-alt');

            if (data.is_policy) {
                // Add shield icon if not present
                if (!icon) {
                    const shieldIcon = document.createElement('i');
                    shieldIcon.className = 'fas fa-shield-alt text-blue-500 mr-2';
                    shieldIcon.title = 'Policy';
                    nameCell.insertBefore(shieldIcon, nameCell.firstChild);
                }
            } else {
                // Remove shield icon if present
                if (icon) {
                    icon.remove();
                }
            }
        } else {
            alert('Error toggling policy flag');
            // Revert checkbox state
            checkbox.checked = !checkbox.checked;
        }
    })
    .catch(error => {
        console.error('Error toggling policy:', error);
        alert('Error toggling policy flag');
        // Revert checkbox state
        checkbox.checked = !checkbox.checked;
    });
}

// Expenses by Category Pie Chart
const expensesByCategory = {{ expenses_by_category | tojson }};
const categoryLabels = Object.keys(expensesByCategory);
const categoryData = Object.values(expensesByCategory);

if (categoryLabels.length > 0) {
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
        type: 'pie',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryData,
                backgroundColor: [
                    '#10B981', '#3B82F6', '#F59E0B', '#8B5CF6', '#EC4899', '#6B7280',
                    '#EF4444', '#14B8A6', '#F97316', '#06B6D4'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return label + ': ' + new Intl.NumberFormat('en-GB', {
                                style: 'currency',
                                currency: 'GBP'
                            }).format(value) + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}

// Fixed vs Discretionary Pie Chart
const fixedAmount = {{ fixed_costs }};
const discretionaryAmount = {{ discretionary }};

if (fixedAmount > 0 || discretionaryAmount > 0) {
    const fixedDiscCtx = document.getElementById('fixedDiscChart').getContext('2d');
    new Chart(fixedDiscCtx, {
        type: 'doughnut',
        data: {
            labels: ['Fixed Costs', 'Discretionary'],
            datasets: [{
                data: [fixedAmount, discretionaryAmount],
                backgroundColor: ['#3B82F6', '#8B5CF6'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return label + ': ' + new Intl.NumberFormat('en-GB', {
                                style: 'currency',
                                currency: 'GBP'
                            }).format(value) + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}
